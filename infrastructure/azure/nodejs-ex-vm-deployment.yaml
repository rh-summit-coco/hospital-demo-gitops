---
# Namespace for Azure infrastructure management
apiVersion: v1
kind: Namespace
metadata:
  name: azure-infrastructure
---
# Secret containing Azure credentials
apiVersion: v1
kind: Secret
metadata:
  name: azure-credentials
  namespace: azure-infrastructure
type: Opaque
stringData:
  AZURE_CLIENT_ID: "<REPLACE_WITH_YOUR_AZURE_CLIENT_ID>"
  AZURE_CLIENT_SECRET: "<REPLACE_WITH_YOUR_AZURE_CLIENT_SECRET>"
  AZURE_TENANT_ID: "<REPLACE_WITH_YOUR_AZURE_TENANT_ID>"
  AZURE_SUBSCRIPTION_ID: "<REPLACE_WITH_YOUR_AZURE_SUBSCRIPTION_ID>"
---
# ConfigMap with cloud-init script
apiVersion: v1
kind: ConfigMap
metadata:
  name: nodejs-ex-vm-cloud-init
  namespace: azure-infrastructure
data:
  cloud-init.yaml: |
    #cloud-config
    package_update: true
    package_upgrade: true

    packages:
      - podman
      - podman-docker
      - firewalld
      - nginx

    write_files:
      - path: /etc/systemd/system/nodejs-ex.service
        owner: root:root
        permissions: '0644'
        content: |
          [Unit]
          Description=Node.js Example Application (from OpenShift)
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          Restart=always
          RestartSec=10
          TimeoutStartSec=300

          ExecStartPre=-/usr/bin/podman rm -f nodejs-ex
          ExecStartPre=/usr/bin/podman pull --tls-verify=false default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io/janine-dev/nodejs-ex:latest
          ExecStart=/usr/bin/podman run --rm \
            --name nodejs-ex \
            -p 8080:8080 \
            -e NODE_ENV=production \
            -e PORT=8080 \
            default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io/janine-dev/nodejs-ex:latest

          ExecStop=/usr/bin/podman stop -t 10 nodejs-ex

          [Install]
          WantedBy=multi-user.target

      - path: /etc/nginx/conf.d/nodejs-ex.conf
        owner: root:root
        permissions: '0644'
        content: |
          server {
              listen 80;
              server_name _;

              location / {
                  proxy_pass http://localhost:8080;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              }
          }

      - path: /usr/local/bin/update-nodejs-ex.sh
        owner: root:root
        permissions: '0755'
        content: |
          #!/bin/bash
          set -e
          echo "=== Updating nodejs-ex ==="
          podman pull --tls-verify=false default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io/janine-dev/nodejs-ex:latest
          systemctl restart nodejs-ex.service
          echo "✅ Updated successfully"

    runcmd:
      - systemctl enable firewalld
      - systemctl start firewalld
      - firewall-cmd --permanent --add-service=http
      - firewall-cmd --permanent --add-port=8080/tcp
      - firewall-cmd --reload
      - systemctl enable nginx
      - systemctl start nginx
      - systemctl daemon-reload
      - systemctl enable nodejs-ex.service
      - systemctl start nodejs-ex.service
---
# Job to deploy/update the RHEL VM
apiVersion: batch/v1
kind: Job
metadata:
  name: deploy-nodejs-ex-vm
  namespace: azure-infrastructure
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 600
  template:
    spec:
      serviceAccountName: azure-vm-deployer
      restartPolicy: OnFailure
      containers:
      - name: azure-cli
        image: mcr.microsoft.com/azure-cli:latest
        env:
        - name: HOME
          value: "/tmp"
        - name: AZURE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: azure-credentials
              key: AZURE_CLIENT_ID
        - name: AZURE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: azure-credentials
              key: AZURE_CLIENT_SECRET
        - name: AZURE_TENANT_ID
          valueFrom:
            secretKeyRef:
              name: azure-credentials
              key: AZURE_TENANT_ID
        - name: AZURE_SUBSCRIPTION_ID
          valueFrom:
            secretKeyRef:
              name: azure-credentials
              key: AZURE_SUBSCRIPTION_ID
        - name: RESOURCE_GROUP
          value: "nodejs-ex-vm-rg"
        - name: VM_NAME
          value: "nodejs-ex-rhel-vm"
        - name: LOCATION
          value: "eastus"
        volumeMounts:
        - name: cloud-init
          mountPath: /cloud-init
        - name: ssh-key
          mountPath: /tmp/.ssh
        - name: azure-home
          mountPath: /tmp
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "=== Logging in to Azure ==="
          az login --service-principal \
            -u $AZURE_CLIENT_ID \
            -p $AZURE_CLIENT_SECRET \
            --tenant $AZURE_TENANT_ID

          az account set --subscription $AZURE_SUBSCRIPTION_ID

          echo "=== Checking if VM exists ==="
          if az vm show -g $RESOURCE_GROUP -n $VM_NAME &>/dev/null; then
            echo "✅ VM exists - triggering update"

            # Get VM IP
            VM_IP=$(az vm show -d -g $RESOURCE_GROUP -n $VM_NAME --query publicIps -o tsv)

            echo "VM IP: $VM_IP"
            echo "Updating container via SSH..."

            # Note: This requires SSH access - alternative is to use Azure Run Command
            az vm run-command invoke \
              -g $RESOURCE_GROUP \
              -n $VM_NAME \
              --command-id RunShellScript \
              --scripts "/usr/local/bin/update-nodejs-ex.sh" || true

            echo "✅ Update triggered on existing VM"
          else
            echo "VM doesn't exist - creating new VM"

            # Create resource group if not exists
            az group create --name $RESOURCE_GROUP --location $LOCATION || true

            # Create VM with cloud-init
            az vm create \
              --resource-group $RESOURCE_GROUP \
              --name $VM_NAME \
              --image RedHat:rhel-raw:9_4:latest \
              --size Standard_D2s_v3 \
              --admin-username azureuser \
              --ssh-key-values "$(cat /tmp/.ssh/id_rsa.pub)" \
              --public-ip-sku Standard \
              --custom-data /cloud-init/cloud-init.yaml \
              --os-disk-size-gb 64

            # Open ports
            az vm open-port -g $RESOURCE_GROUP -n $VM_NAME --port 80 --priority 1000
            az vm open-port -g $RESOURCE_GROUP -n $VM_NAME --port 8080 --priority 1001

            # Get public IP
            VM_IP=$(az vm show -d -g $RESOURCE_GROUP -n $VM_NAME --query publicIps -o tsv)

            echo ""
            echo "============================================"
            echo "✅ nodejs-ex VM deployed successfully!"
            echo ""
            echo "VM IP: $VM_IP"
            echo "Application URL: http://$VM_IP"
            echo "Direct URL: http://$VM_IP:8080"
            echo "============================================"
          fi

      volumes:
      - name: cloud-init
        configMap:
          name: nodejs-ex-vm-cloud-init
      - name: ssh-key
        secret:
          secretName: azure-ssh-key
          defaultMode: 0600
      - name: azure-home
        emptyDir: {}
---
# ServiceAccount for VM deployment
apiVersion: v1
kind: ServiceAccount
metadata:
  name: azure-vm-deployer
  namespace: azure-infrastructure
---
# Role for VM deployment job
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: azure-vm-deployer
  namespace: azure-infrastructure
rules:
- apiGroups: [""]
  resources: ["secrets", "configmaps"]
  verbs: ["get", "list"]
---
# RoleBinding for VM deployment
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: azure-vm-deployer
  namespace: azure-infrastructure
subjects:
- kind: ServiceAccount
  name: azure-vm-deployer
  namespace: azure-infrastructure
roleRef:
  kind: Role
  name: azure-vm-deployer
  apiGroup: rbac.authorization.k8s.io
