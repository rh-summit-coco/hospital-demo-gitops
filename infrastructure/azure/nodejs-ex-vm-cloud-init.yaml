#cloud-config
# Cloud-init configuration for nodejs-ex RHEL VM
# This runs on first boot to configure the VM to pull and run the container

package_update: true
package_upgrade: true

packages:
  - podman
  - podman-docker
  - firewalld
  - nginx

write_files:
  # Pull secret for OpenShift image registry
  - path: /root/.docker/config.json
    owner: root:root
    permissions: '0600'
    content: |
      {
        "auths": {
          "image-registry.openshift-image-registry.svc:5000": {
            "auth": "REPLACE_WITH_BASE64_TOKEN"
          },
          "default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io": {
            "auth": "REPLACE_WITH_BASE64_TOKEN"
          }
        }
      }

  # Systemd service for nodejs-ex
  - path: /etc/systemd/system/nodejs-ex.service
    owner: root:root
    permissions: '0644'
    content: |
      [Unit]
      Description=Node.js Example Application (from OpenShift)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=simple
      Restart=always
      RestartSec=10
      TimeoutStartSec=300

      # Pull latest image and run
      ExecStartPre=-/usr/bin/podman rm -f nodejs-ex
      ExecStartPre=/usr/bin/podman pull default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io/janine-dev/nodejs-ex:latest
      ExecStart=/usr/bin/podman run --rm \
        --name nodejs-ex \
        -p 8080:8080 \
        -e NODE_ENV=production \
        -e PORT=8080 \
        default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io/janine-dev/nodejs-ex:latest

      ExecStop=/usr/bin/podman stop -t 10 nodejs-ex

      [Install]
      WantedBy=multi-user.target

  # Nginx reverse proxy configuration
  - path: /etc/nginx/conf.d/nodejs-ex.conf
    owner: root:root
    permissions: '0644'
    content: |
      server {
          listen 80;
          server_name _;

          location / {
              proxy_pass http://localhost:8080;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }

          location /health {
              proxy_pass http://localhost:8080/health;
              access_log off;
          }
      }

  # Script to update container image (called by ArgoCD)
  - path: /usr/local/bin/update-nodejs-ex.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      # Pull latest image and restart service
      set -e

      echo "=== Updating nodejs-ex container ==="

      # Pull latest image
      podman pull default-route-openshift-image-registry.apps.uhfgfgde.eastus.aroapp.io/janine-dev/nodejs-ex:latest

      # Restart service (will use new image)
      systemctl restart nodejs-ex.service

      # Wait for service to be ready
      sleep 5

      # Check status
      systemctl status nodejs-ex.service --no-pager

      echo "âœ… nodejs-ex updated successfully"

runcmd:
  # Configure firewall
  - systemctl enable firewalld
  - systemctl start firewalld
  - firewall-cmd --permanent --add-service=http
  - firewall-cmd --permanent --add-service=https
  - firewall-cmd --permanent --add-port=8080/tcp
  - firewall-cmd --reload

  # Enable and start nginx
  - systemctl enable nginx
  - systemctl start nginx

  # Enable and start nodejs-ex service
  - systemctl daemon-reload
  - systemctl enable nodejs-ex.service
  - systemctl start nodejs-ex.service

  # Wait for service to start
  - sleep 10

  # Log status
  - systemctl status nodejs-ex.service --no-pager || true
  - podman ps -a

final_message: |
  ============================================
  nodejs-ex RHEL VM is ready!

  Application running on port 8080
  Nginx proxy on port 80

  To update the container:
    sudo /usr/local/bin/update-nodejs-ex.sh

  To check status:
    sudo systemctl status nodejs-ex.service
    sudo podman logs nodejs-ex
  ============================================
